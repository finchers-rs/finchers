dist: trusty
sudo: false
language: rust

cache:
  - apt: true
  - cargo: true

branches:
  only:
    - master

matrix:
  allow_failures:
    - rust: nightly

  include:
    - rust: stable
      sudo: required
      addons:
        apt:
          packages:
            - libcurl4-openssl-dev
            - libelf-dev
            - libdw-dev
            - binutils-dev
      before_script:
        - rustup component add rustfmt-preview
        - cargo install cargo-update || true
        - cargo install cargo-kcov || true
        - cargo install-update -a
        - export CARGO_INCREMENTAL=0
      script:
        - cargo fmt -- --check
        - cargo update
        - cargo test --features strict
        - if [[ "${TRAVIS_PULL_REQUEST_BRANCH:-}" = release-* ]]; then cargo package; fi
      after_success:
        - cargo kcov --print-install-kcov-sh | sh
        - cargo kcov -v --coveralls

    - rust: beta
      before_script:
        - export CARGO_INCREMENTAL=0
      script:
        - cargo update
        - cargo test --all

    - rust: nightly
      before_script:
        - export CARGO_INCREMENTAL=0
      script:
        - cargo update
        - cargo test --all

    - rust: nightly
      env: LINT
      before_script:
        - rustup component add clippy-preview
        - export CARGO_INCREMENTAL=0
      script:
        - cargo clippy --features lint

    - rust: stable
      env: DEPLOY_DOCS
      before_script:
        - curl -sSLf https://github.com/rust-lang-nursery/mdBook/releases/download/v0.2.1/mdbook-v0.2.1-x86_64-unknown-linux-gnu.tar.gz | tar xzf -
        - chmod +x ./mdbook
      script:
        - cargo clean
        - cargo update
        - cargo doc --all
        - ./mdbook build ./guide/
        - rm -f target/doc/.lock
      deploy:
        provider: pages
        skip_cleanup: true
        github_token: $GH_TOKEN
        repo: finchers-rs/finchers
        target_branch: gh-pages
        local_dir: target/doc
        on:
          branch: master
